#summary JavaCV versions of C++ examples from chapter 1 of the book "OpenCV2 Computer Vision Applications Programming Cookbook" titled "Playing with Images"
#labels Featured

<wiki:toc max_depth="2" />

= Introduction =

To work with OpenCV from a Java platform you need to install OpenCV and the JavaCV.
The examples use a bit different setup than default.
It is described below.

The example code can be used in any IDE or from command line. 
Description here focused on using IntelliJ IDEA, and show how it can be setup run each example with minimum effort. 
If you have experience with Eclipse, NetBeans, or other, you should be able to use them too.

The idea is that once you are setup you can run any JavaCV example, or you own JavaCV code, 
by simply right clicking on a code file and selecting 'Run'. Please go through a couple of steps below to get it ready.
If you have some suggestions how to make this process simpler please comment at the bottom of the page or send an email.

Examples here are written in Scala. 
IntelliJ IDEA as it has an excellent support for Scala, and it is also an excellent Java IDE. 
The setup works with both the free IDEA Community and the paid IDEA Ultimate editions.

== Installing IDE for work with JavaCV ==
You will need to download and install the development environment components:

  * [http://www.oracle.com/technetwork/java/javase/downloads/index.html Java SE SDK]
  * [http://www.jetbrains.com/idea/ IntelliJ IDEA]
  * [http://www.scala-lang.org/downloads Scala], optional but recommended for Scala development.

Once you have IDEA installed you can install IDEA's Scala plugin. 

  # Startup IDEA and 
  # Select from the menu Settings > Plugins > Available.
  # Click on the "Available" tab and wait for IDEA to download list of plugins from its website
  # Find Scala plugin on the list, then right-click and select "Download and Install"
  # After the plugin installs you will need to restart IDEA
  
==Getting the OpenCV Cookbook Examples for JavaCV==
The OpenCV Cookbook Examples for JavaCV are available through Subversion code repository. 
You can download it isung IDEA, described in next section, or you can also use your favorite Subversion client follwing information on the examples [https://code.google.com/p/javacv-examples/source/checkout Source] page.

==Downloading Examples using IDEA==

  # Start IDEA
  # Select from menu: `Version Control` > `Checkout from Version Control` > `Subversion` <br> [javacv-examples.googlecode.com/svn/wiki/Ch1_Checkout_from_Subversion_1.png]
  # Click on the "+" next to `Repositories` and add location of the `OpenCV2_Cookbook` examples: `http://javacv-examples.googlecode.com/svn/trunk/` <br> [Ch1_New_Repository_Location_1.png] 
  # Click `OK` to add return to `Checkout from Subversion` dialog. 
  # Select `http://javacv-examples.googlecode.com/svn/trunk/`  <br>  [Ch1_Checkout_from_Subversion_1.png]  <br> And click on `Checkout`
  # Select location for the example code (you may have to create a new folder, call it `javacv-examples`)
  # Confirm checkout options (default should be fine)
  # Confirm repository format version (default should be fine)
  # Wait for IDEA to download the examples
  # Once download is finished, IDEA will ask you whether to create a project for the examples. Select `No` since the checkout already has project definintion.
  # Select from manu `File` > `Open Project...` and select the folder where you have checked out the code.

==...==
...

==Installing OpenCV and JavaCV Libraries==
Now you need to get OpenCV and JavaCV libraries.
The recommended way is to use  pre-configured combined OpenCV+JavaCV binaries that can be downloaded with the examples. 
The archive contains all the needed native dependencies for OpenCV and JavaCV in a single directory. 
It is intended to be extracted into a `sandbox` subdirectory under the `OpenCV2_Cookbook` directory 
Make sure that they the binaries are in `sandbox` not in its subdirectory. 
You project structure should look like this `[image]`.

==Setup Working Directory==

And the very last step of setup, configure default startup directory. 
  # Select `Run` > `Edit Configurations`
  # Expand the `Defaults` node and select `Application`
  # Under working directory type `$MODULE_DIR$\sandbox` 

==Run the Examples==
Now you are ready to test the examples. For instance, to run the first example from chapter 1:
  # in project window select Ex1MyFirstOpenCVApp
  # Right click on it and select `Run`

If everything goes fine the example will be compiled and run. It should open the image and display it on the screen. <br> [Ch1_My_Image_1.png]

== Troubleshooting ==
===UnsatisfiedLinkError===
If you get an error message that looks like this
{{{
Exception in thread "main" java.lang.UnsatisfiedLinkError: no jniopencv_core in java.library.path
	at java.lang.ClassLoader.loadLibrary(ClassLoader.java:...
}}}	
This means that you native binaries are not setup correctly. Make sure that you follow instructions in section
[OpenCV2_Cookbook_Examples_Chapter_1.wiki#Installing_OpenCV_and_JavaCV_Libraries Installing OpenCV and JavaCV Libraries] and
in [OpenCV2_Cookbook_Examples_Chapter_1.wiki#Setup_Working_Directory Setup_Working_Directory]

===NullPointerException in CanvasFrame.showImage()===
If you get an error message that looks like this
{{{
Exception in thread "main" java.lang.NullPointerException
	at com.googlecode.javacv.CanvasFrame.showImage(CanvasFrame.java:331)
	at opencv2_cookbook.chapter01.Ex01MyFirstOpenCVApp$delayedInit$body.apply(Ex01MyFirstOpenCVApp.scala:31)
	...
}}}
Congratulations, your first JavaCV application actually started but had trouble loading an image.
The `Ex01MyFirstOpenCVApp` is very simple and does not check if image was actually loaded.
If it was not the `image` variable is set to `null`.
It is then passed to CanvasFrame and is causing an exception.
You may need to check if the image is in the right place in the relation to the startup directory.

= Loading, Displaying, and Saving Images with JavaCV =

A simple example of loading and displaying an image using JavaCV is in class `opencv2_cookbook.chapter01.Ex01MyFirstOpenCVApp`:
{{{
import com.googlecode.javacv.CanvasFrame
import com.googlecode.javacv.cpp.opencv_highgui._
import javax.swing.JFrame._

object Ex01MyFirstOpenCVApp extends App {

    // read an image
    val image = cvLoadImage("boldt.jpg")

    // create image window named "My Image"
    val canvas = new CanvasFrame("My Image")

    // request closing of the application when the image window is closed
    canvas.setDefaultCloseOperation(EXIT_ON_CLOSE)

    // show image on window
    canvas.showImage(image)
}
}}}
It is based on the example on page 18 of the cookbook. Note how `CanvasFrame` from JavaCV API is used to display the image.

==Loading Images==

JavaCV methods for loading images and saving images are based on based on OpenCV. They are in the class `com.googlecode.javacv.cpp.opencv_highgui`.
Note that class is in named starting with small letter to look similar to the C++ module `opencv_highgui` where OpenCV method for reading and writing images are located.
Images can be loaded in two formats `IplImage` using `cvLoadImage` and `CvMat` using `cvLoadImageM`.
`cvLoadImage` takes one or two parameters.
The first parameter is a file name, the second is a conversion parameter, frequently used to use color images area gray scale.
Here are some examples.
{{{
import com.googlecode.javacv.cpp.opencv_highgui._
import com.googlecode.javacv.cpp.opencv_core.IplImage

val image1: IplImage = cvLoadImage("../data/boldt.jpg")
val image2: IplImage = cvLoadImage("../data/boldt.jpg", CV_LOAD_IMAGE_COLOR)
val image3: IplImage = cvLoadImage("../data/boldt.jpg", CV_LOAD_IMAGE_GRAYSCALE)
}}}
The default value for the conversion parameter is `CV_LOAD_IMAGE_COLOR`.

To load image in `CvMat` format use `cvLoadImageM`, parameter are the same as for `cvLoadImage`:
{{{
import com.googlecode.javacv.cpp.opencv_core.CvMat

val image4: CvMat = cvLoadImageM("../data/boldt.jpg")
val image5: CvMat = cvLoadImageM("../data/boldt.jpg", CV_LOAD_IMAGE_COLOR)
val image6: CvMat = cvLoadImageM("../data/boldt.jpg", CV_LOAD_IMAGE_GRAYSCALE)
}}}

If image cannot be loaded both `cvLoadImage` and `cvLoadImageM` return `null`. They do not throw exceptions.
You may want to wrap a call to `cvLoadImage` (or `cvLoadImageM`) in a method that throws an exception if an image cannot be loaded.
{{{
def load(file: File, flags: Int = CV_LOAD_IMAGE_GRAYSCALE): IplImage = {
    // Verify file
    if (!file.exists()) {
        throw new FileNotFoundException("Image file does not exist: " + file.getAbsolutePath)
    }
    // Read input image
    val image = cvLoadImage(file.getAbsolutePath, flags)
    if (image == null) {
        throw new IOException("Couldn't load image: " + file.getAbsolutePath)
    }
    // Return loaded image
    image
}
}}}

==Saving Images==

The method `cvSaveImage(filename, image)` saves the image to the specified file.
The image format is chosen based on the filename extension.
The method returns an error code.
{{{
 val err : Int = cvSaveImage("my_image.png", image1)
}}}

==Displaying Images==

The easy way to display image using JavaCV is to use `CanvasFrame` as in the example `Ex01MyFirstOpenCVApp`, see above or [https://code.google.com/p/javacv-examples/source/browse/trunk/OpenCV2_Cookbook/src/opencv2_cookbook/chapter01/Ex01MyFirstOpenCVApp.scala here].
It shows the image in a new window.

JavaCV also add to  `IplImage` a method `getBufferedImage` to convert OpenCV data to Java's `java.awt.image.BufferedImage` that can be displayed using standard Java approach.
You can see example of that in `Ex2MyFirstGUIApp`, see next section.


= Creating a GUI application using Scala Swing =

It is not an intention of this module to describe how to create GUI applications in Scala or Java.
However for the sake of completeness an equivalent of a Qt GUI application presented in the Cookbook is provided.
As the original, it is a simple frame with two buttons "Open Image" and "Process" on the left.
Loaded image is displayed in the middle of the frame. The example is using Scala Swing framework, which may be interesting in its own right.

[Ex01MyFirstOpenCVApp.png]

You can find code for the `Ex2MyFirstGUIApp` example [https://code.google.com/p/javacv-examples/source/browse/trunk/OpenCV2_Cookbook/src/opencv2_cookbook/chapter01/Ex2MyFirstGUIApp.scala here].